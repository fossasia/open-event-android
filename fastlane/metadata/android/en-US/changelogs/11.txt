Several enhancements and bug fixes